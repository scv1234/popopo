<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Polymarket Pro Terminal</title>
    <style>
        :root { 
            --bg: #0d1117; 
            --panel: #161b22; 
            --border: #30363d; 
            --accent: #238636; 
            --accent-hover: #2ea043;
            --text: #c9d1d9; 
            --text-muted: #8b949e;
            --red: #da3633; 
            --red-hover: #f85149;
            --gold: #e2b93d; 
            --blue: #58a6ff;
            --gray: #6e7681;
        }
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0; 
            padding: 20px; 
            font-size: 14px;
        }
        
        .container { 
            display: grid; 
            grid-template-columns: 280px 1fr; 
            gap: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }

        .panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        h2 { 
            margin: 0; 
            font-size: 16px; 
            font-weight: 600; 
            color: var(--text); 
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: #21262d; padding: 12px; border-radius: 6px; text-align: center; }
        .stat-val { font-size: 18px; font-weight: 700; display: block; margin-bottom: 4px; color: var(--text); }
        .stat-label { font-size: 12px; color: var(--text-muted); }

        label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; margin-top: 12px; }
        input[type="text"], input[type="number"] { 
            background: #0d1117; 
            border: 1px solid var(--border); 
            color: var(--text); 
            padding: 10px; 
            width: 100%; 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-family: 'Consolas', monospace;
        }
        input:focus { outline: none; border-color: var(--blue); }
        
        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 12px; 
            width: 100%; 
            cursor: pointer; 
            font-weight: 600; 
            border-radius: 6px; 
            margin-top: 10px;
            transition: background 0.2s;
        }
        button:hover { background: var(--accent-hover); }
        
        .btn-red { background: var(--red); }
        .btn-red:hover { background: var(--red-hover); }
        .btn-gray { background: var(--gray); }
        .btn-gray:hover { opacity: 0.8; }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        
        th { 
            text-align: left; 
            color: var(--text-muted); 
            padding: 12px 8px; 
            border-bottom: 1px solid var(--border); 
            font-weight: 500;
            cursor: pointer;
            position: sticky;
            top: 0;
            background: var(--panel);
            z-index: 10;
        }
        
        th:hover { color: var(--text); }
        td { padding: 12px 8px; border-bottom: 1px solid #21262d; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #21262d; cursor: pointer; }
        
        .row-selected { background-color: rgba(88, 166, 255, 0.1) !important; }

        .market-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 320px;
        }
        .market-title-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            cursor: pointer;
        }
        .market-title-text:hover { color: var(--blue); text-decoration: underline; }
        .market-icon-link { flex-shrink: 0; text-decoration: none; opacity: 0.7; font-size: 14px; }
        .market-icon-link:hover { opacity: 1; transform: scale(1.2); }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        
        .profit-pos { color: #7ee787; font-weight: bold; }
        .profit-neu { color: var(--text-muted); }
        
        .logs { 
            height: 150px; 
            overflow-y: auto; 
            font-family: 'Consolas', monospace; 
            font-size: 12px; 
            color: var(--text-muted); 
            line-height: 1.4;
            background: #0d1117;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .sim-input-group { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); }
        .sim-input { 
            width: 80px !important; 
            padding: 6px !important; 
            text-align: right; 
            border-color: var(--border);
            margin: 0 !important;
            height: auto;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body>

<div class="container">
    <div>
        <div class="panel">
            <div class="panel-header"><h2>ü§ñ System Status</h2></div>
            <div id="bot-status" class="stat-box" style="cursor: default;">Connecting...</div>
            
            <div class="status-grid">
                <div class="stat-box">
                    <span id="wallet-usdc" class="stat-val">-</span>
                    <span class="stat-label">USDC Balance</span>
                </div>
                <div class="stat-box">
                    <span id="wallet-matic" class="stat-val">-</span>
                    <span class="stat-label">MATIC Gas</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; font-size: 12px; color: var(--text-muted); display: flex; justify-content: space-between;">
                <span>Skew: <b id="inv-skew" style="color:var(--text)">-</b></span>
                <span>Net Exposure: <b id="inv-net" style="color:var(--text)">-</b></span>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><h2>üöÄ Quick Trade</h2></div>
            
            <label>Target Market ID</label>
            <input type="text" id="order-market-id" placeholder="Select from list..." readonly style="cursor: not-allowed; opacity: 0.7;">
            
            <label>Investment Amount ($)</label>
            <input type="number" id="order-amount" value="100">
            
            <button onclick="placeOrder()" id="btn-order">Place Buy Order</button>

            <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 10px;">
                <label>Emergency Controls</label>
                <button onclick="batchCancelManual()" class="btn-gray">Batch Cancel All Manual Orders</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><h2>üìù Active Orders</h2></div>
            <div id="open-orders" style="font-size: 13px; min-height: 50px; color: var(--text-muted);">No active orders</div>
        </div>
    </div>

    <div>
        <div class="panel">
            <div class="panel-header">
                <h2>üçØ Market Opportunities</h2>
                <div class="sim-input-group">
                    <span>Simulation Base: $</span>
                    <input type="number" id="sim-amount" class="sim-input" value="1000" onchange="updateMarkets()">
                </div>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th width="8%" onclick="setSort('score')">Score ‚ñæ</th>
                            <th width="32%">Market Title</th> 
                            <th width="10%">Min Shares</th>   
                            <th width="12%">Reward/Day</th>
                            <th width="12%" onclick="setSort('profit')">Est. Profit ‚ñæ</th>
                            <th width="10%">Depth</th>
                            <th width="8%">Spread</th>
                            <th width="8%">Mid</th>
                        </tr>
                    </thead>
                    <tbody id="market-table">
                        <tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading market data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header" style="border-bottom: none; margin-bottom: 5px;">
                <h2>üìú System Logs</h2>
                <button onclick="clearLogs()" style="width: auto; padding: 4px 8px; font-size: 11px; margin: 0; background: var(--border);">Clear</button>
            </div>
            <div id="logs" class="logs"></div>
        </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8000";
    let sortKey = 'score';
    let selectedId = null;
    let marketDataMap = {};

    async function updateStatus() {
        try {
            const res = await fetch(`${API_URL}/status`);
            const data = await res.json();
            const statusBox = document.getElementById('bot-status');
            if (data.is_halted) {
                statusBox.textContent = "üö® HALTED (Click to Reset)";
                statusBox.style.background = "var(--red)";
                statusBox.onclick = resetHalt;
                statusBox.style.cursor = "pointer";
            } else {
                statusBox.textContent = "üü¢ SYSTEM ONLINE";
                statusBox.style.background = "var(--accent)";
                statusBox.onclick = null;
                statusBox.style.cursor = "default";
            }
            document.getElementById('inv-skew').textContent = data.inventory.skew.toFixed(2);
            document.getElementById('inv-net').textContent = Math.round(data.inventory.net_shares);
        } catch (e) {}
    }

    async function updateWallet() {
        try {
            const res = await fetch(`${API_URL}/wallet`);
            const data = await res.json();
            document.getElementById('wallet-usdc').textContent = `$${Math.floor(data.usdc_balance).toLocaleString()}`;
            document.getElementById('wallet-matic').textContent = data.matic_balance.toFixed(3);
        } catch (e) {}
    }

    async function updateMarkets() {
        try {
            const res = await fetch(`${API_URL}/honey-pots`);
            const data = await res.json();
            const tbody = document.getElementById('market-table');
            marketDataMap = {};
            data.forEach(m => { marketDataMap[m.market_id] = m; });
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 30px; color: var(--text-muted);">No opportunities found.</td></tr>';
                return;
            }

            const simAmt = parseFloat(document.getElementById('sim-amount').value) || 1000;
            data.forEach(m => {
                let totalPool = m.total_depth + simAmt;
                m.estProfit = (simAmt / totalPool) * m.reward;
            });

            data.sort((a,b) => {
                if(sortKey === 'profit') return b.estProfit - a.estProfit;
                return b.score - a.score;
            });

            let html = '';
            data.forEach(m => {
                const isSelected = (m.market_id === selectedId) ? 'row-selected' : '';
                const profitClass = m.estProfit > 10 ? 'profit-pos' : 'profit-neu';
                
                html += `<tr onclick="selectMarket('${m.market_id}')" class="${isSelected}">
                    <td style="color:var(--gold); font-weight:bold;">${m.score.toFixed(1)}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 280px;" title="${m.title}">${m.title}</div>
                            <a href="https://polymarket.com/event/${m.slug}" target="_blank" onclick="event.stopPropagation()" style="text-decoration: none; color: var(--blue); font-size: 14px;">üîó</a>
                        </div>
                    </td>
                    <td style="color:var(--blue); font-weight:500;">${m.min_size}</td> 
                    <td>$${m.reward.toLocaleString()}</td>
                    <td class="${profitClass}">$${m.estProfit.toFixed(2)}</td>
                    <td style="color:var(--text-muted)">$${m.total_depth.toLocaleString()}</td>
                    <td><span class="badge badge-blue">${m.spread_cents}¬¢</span></td>
                    <td style="font-family:Consolas">${m.mid_yes.toFixed(3)}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        } catch (e) {}
    }

    async function updateOrdersAndLogs() {
        try {
            const res = await fetch(`${API_URL}/open-orders`);
            const orders = await res.json();
            const div = document.getElementById('open-orders');
            if (orders.length === 0) {
                div.innerHTML = '<div style="text-align:center; padding:15px; color:var(--text-muted);">No active orders</div>';
            } else {
                div.innerHTML = orders.map(o => `
                    <div style="border-bottom:1px solid #30363d; padding:12px 0; display:flex; flex-direction:column; gap:5px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <span class="badge" style="background:${o.side==='BUY'?'rgba(35,134,54,0.2)':'rgba(218,54,51,0.2)'}; color:${o.side==='BUY'?'#7ee787':'#f85149'}">${o.side}</span>
                                <b style="color:var(--gold); margin-left:5px;">${o.outcome}</b>
                                <span style="font-weight:bold; margin-left:5px;">${parseFloat(o.size).toFixed(0)}</span>
                            </div>
                            <button onclick="cancelById('${o.order_id}')" style="width:auto; margin:0; padding:4px 8px; font-size:11px; background:var(--red); height:24px;">Cancel</button>
                        </div>
                        <div style="font-size:11px; color:var(--text-muted); display:flex; justify-content:space-between;">
                            <span>MKT: ${o.market.substring(0,12)}...</span>
                            <span>Price: ${o.price}</span>
                        </div>
                    </div>
                `).join('');
            }

            // [ÌïµÏã¨ ÏàòÏ†ï] Ï§ëÏöî Ïù¥Î≤§Ìä∏Îßå ÌïÑÌÑ∞ÎßÅÌïòÏó¨ Î°úÍ∑∏ ÌëúÏãú
            const logRes = await fetch(`${API_URL}/logs`);
            const logs = await logRes.json();
            const logDiv = document.getElementById('logs');
            
            const filteredLogs = logs.filter(line => {
                const upper = line.toUpperCase();
                return upper.includes("EXECUTED") || 
                       upper.includes("FAILED") || 
                       upper.includes("BLOCKED") || 
                       upper.includes("UNSTABLE") || 
                       upper.includes("VOLATILITY") || 
                       upper.includes("SPREAD") || 
                       upper.includes("EMERGENCY") || 
                       upper.includes("DEFENSIVE") || 
                       upper.includes("CIRCUIT");
            });

            const recentLogs = filteredLogs.slice(-50);
            if (logDiv.dataset.lastLog !== JSON.stringify(recentLogs)) {
                logDiv.innerHTML = recentLogs.map(line => `<div>${line}</div>`).join('');
                logDiv.scrollTop = logDiv.scrollHeight;
                logDiv.dataset.lastLog = JSON.stringify(recentLogs);
            }
        } catch (e) {}
    }

    function selectMarket(id) {
        selectedId = id;
        document.getElementById('order-market-id').value = id;
        updateMarkets();
        const btn = document.getElementById('btn-order');
        btn.textContent = "Ready to Buy";
        setTimeout(() => btn.textContent = "Place Buy Order", 1000);
    }

    async function placeOrder() {
        const id = document.getElementById('order-market-id').value;
        const amt = parseFloat(document.getElementById('order-amount').value);
        if(!id) return alert("Please select a market.");
        const marketInfo = marketDataMap[id];
        if(!confirm(`Confirm Order?\nMarket: ${id}\nAmount: $${amt}`)) return;
        const btn = document.getElementById('btn-order');
        btn.textContent = "Processing..."; btn.disabled = true;
        try {
            const res = await fetch(`${API_URL}/place-semi-auto-order`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    market_id: id, amount: amt,
                    yes_token_id: marketInfo.yes_token_id, no_token_id: marketInfo.no_token_id
                })
            });
            if(res.ok) {
                btn.style.background = "var(--accent)"; btn.textContent = "‚úÖ Placed!";
                updateOrdersAndLogs();
                setTimeout(() => { btn.textContent = "Place Buy Order"; btn.disabled = false; }, 2000);
            } else {
                const err = await res.json();
                alert("Failed: " + err.detail); btn.disabled = false;
            }
        } catch(e) { alert("Error"); btn.disabled = false; }
    }

    async function cancelById(id) {
        if(confirm("Ïù¥ Ï£ºÎ¨∏ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            await fetch(`${API_URL}/cancel-order/${id}`, { method: 'POST' });
            updateOrdersAndLogs();
        }
    }

    async function batchCancelManual() {
        if(confirm("Î™®Îì† ÏàòÎèô Ï£ºÎ¨∏ÏùÑ ÏùºÍ¥Ñ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            await fetch(`${API_URL}/batch-cancel-manual`, { method: 'POST' });
            updateOrdersAndLogs();
        }
    }

    async function resetHalt() {
        if(confirm("Resume system operations?")) {
            await fetch(`${API_URL}/reset-bot`, {method: 'POST'});
            updateStatus();
        }
    }
    function clearLogs() { document.getElementById('logs').innerHTML = ""; }
    function setSort(key) { sortKey = key; updateMarkets(); }

    setInterval(updateStatus, 1000);
    setInterval(updateMarkets, 2000);
    setInterval(updateOrdersAndLogs, 1500);
    setInterval(updateWallet, 10000);
    updateStatus(); updateMarkets(); updateWallet(); updateOrdersAndLogs();
</script>
</body>
</html>