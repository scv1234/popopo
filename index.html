<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Polymarket Pro - Interactive Optimizer</title>
    <style>
        :root { 
            --bg: #0d1117; --panel: #161b22; --border: #30363d; 
            --accent: #238636; --text: #c9d1d9; --text-muted: #8b949e;
            --red: #da3633; --gold: #e2b93d; --blue: #58a6ff;
        }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; 
            margin: 0; padding: 10px; font-size: 13px; height: 100vh; width: 100vw; box-sizing: border-box; overflow: hidden; 
        }
        .main-layout { display: grid; grid-template-columns: 280px 1fr 1.6fr; gap: 10px; height: calc(100vh - 20px); min-height: 0; }
        .column { display: flex; flex-direction: column; gap: 10px; height: 100%; min-height: 0; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; min-height: 0; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 6px; flex-shrink: 0; }
        h2 { margin: 0; font-size: 11px; color: var(--blue); text-transform: uppercase; }
        .content-scroll { overflow-y: auto; flex-grow: 1; min-height: 0; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; } 
        th { text-align: center; color: var(--text-muted); padding: 8px 2px; font-size: 10px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--panel); z-index: 10; }
        td { padding: 8px 2px; border-bottom: 1px solid #21262d; font-size: 11px; vertical-align: middle; text-align: center; }
        
        /* ë§ˆì¼“ íƒ€ì´í‹€ ìŠ¤íƒ€ì¼ */
        .title-cell { text-align: left; overflow: hidden; }
        .title-container { display: flex; align-items: center; width: 100%; }
        .title-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; }

        /* [í•µì‹¬] ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        @keyframes sparkle-glow {
            0% { background: rgba(35, 134, 54, 0.1); box-shadow: inset 0 0 5px var(--accent); }
            50% { background: rgba(226, 185, 61, 0.2); box-shadow: inset 0 0 15px var(--gold); }
            100% { background: rgba(35, 134, 54, 0.1); box-shadow: inset 0 0 5px var(--accent); }
        }
        .highlight-opt {
            animation: sparkle-glow 2s infinite ease-in-out;
            border: 1px solid var(--gold) !important;
            z-index: 5;
        }

        .stat-box { background: #0d1117; padding: 12px; border-radius: 4px; text-align: center; margin-bottom: 6px; }
        input, button { border-radius: 4px; padding: 8px; font-size: 12px; box-sizing: border-box; }
        input { background: #0d1117; border: 1px solid var(--border); color: white; width: 100%; margin-bottom: 8px; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; width: 100%; font-weight: bold; }
        
        .logs { font-family: 'Consolas', monospace; font-size: 11px; color: var(--text-muted); white-space: pre-wrap; word-break: break-all; }
        .link-icon { text-decoration: none; color: var(--blue); font-size: 11px; margin-left: 4px; flex-shrink: 0; }
        .profit-pos { color: #7ee787; font-weight: bold; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="column">
        <div class="panel" style="flex-shrink: 0;">
            <div class="panel-header"><h2>ğŸ¤– System</h2></div>
            <div id="bot-status" class="stat-box" style="padding: 5px; font-size: 11px;">Connecting...</div>
            <div class="stat-box">
                <small style="color: var(--text-muted); font-size: 10px; display: block;">USDC (RPC Wallet)</small>
                <div id="wallet-usdc" style="font-weight: bold; color: var(--gold); font-size: 22px;">$0</div>
            </div>
        </div>
        <div class="panel" style="flex-shrink: 0;">
            <div class="panel-header"><h2>ğŸš€ Quick Trade</h2></div>
            <input type="text" id="order-market-id" readonly placeholder="Click Market Opportunity">
            <input type="number" id="order-amount" value="100">
            <button onclick="placeOrder()">Execute Order</button>
        </div>
        <div class="panel" style="flex-grow: 1;">
            <div class="panel-header"><h2>ğŸ“œ Logs</h2></div>
            <div class="content-scroll"><div id="logs" class="logs"></div></div>
        </div>
    </div>

    <div class="column">
        <div class="panel" style="flex: 0.6;">
            <div class="panel-header"><h2>âš–ï¸ Optimizer</h2></div>
            <div style="display:flex; gap:6px; margin-bottom: 8px;">
                <input type="number" id="opt-budget" value="1000" style="margin:0;">
                <button onclick="runOptimizer()" style="width:70px;">Analyze</button>
            </div>
            <div id="optimizer-result" class="content-scroll">
                <div style="text-align:center; padding-top:20px; color:var(--text-muted);">Ready to analyze.</div>
            </div>
        </div>
        <div class="panel" style="flex: 0.4;">
            <div class="panel-header"><h2>ğŸ“ Orders</h2><button onclick="batchCancelManual()" style="width:auto; padding: 2px 5px; font-size:10px; background:var(--border);">Cancel All</button></div>
            <div id="open-orders" class="content-scroll"><div style="text-align:center; padding-top:20px; color:var(--text-muted);">No orders</div></div>
        </div>
    </div>

    <div class="column">
        <div class="panel flex-grow-1">
            <div class="panel-header"><h2>ğŸ¯ Market Opportunities</h2><div style="display:flex; align-items:center; gap:5px;"><small style="font-size:10px; color:var(--text-muted);">Sim:</small><input type="number" id="sim-amount" value="1000" style="width:60px; margin:0; padding:4px; font-size:11px;" onchange="updateMarkets()"></div></div>
            <div class="content-scroll">
                <table id="main-market-table">
                    <thead><tr><th style="width:35px;">Scr</th><th style="width:auto;">Market Title</th><th style="width:40px;">Shr</th><th style="width:45px;">Mid</th><th style="width:60px;">Depth</th><th style="width:40px;">Sprd</th><th style="width:60px;">Est.R</th><th style="width:55px;">Rwd/d</th></tr></thead>
                    <tbody id="market-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8000";
    let marketData = [];

    // [í•µì‹¬] ì˜µí‹°ë§ˆì´ì € ì‹¤í–‰ í›„ ë§ˆì¼“ ë¦¬ìŠ¤íŠ¸ì— í•˜ì´ë¼ì´íŠ¸ ì ìš©
    function runOptimizer() {
        const budget = parseFloat(document.getElementById('opt-budget').value) || 0;
        const resultDiv = document.getElementById('optimizer-result');
        if (marketData.length === 0) return;

        let allocations = {}; marketData.forEach(m => allocations[m.market_id] = 0);
        let remaining = budget;
        const step = 10;

        while (remaining >= step) {
            let bestM = null;
            let maxRiskAdjustedROI = -1;

            marketData.forEach(m => {
                const x = allocations[m.market_id];
                const minUSD = m.min_size * (m.mid_price || 0.5); 
                const currentRev = (x < minUSD) ? 0 : (m.reward * (x / (m.total_depth + x)));
                const nextX = x + step;
                const nextRev = (nextX < minUSD) ? 0 : (m.reward * (nextX / (m.total_depth + nextX)));
                const efficiency = ((nextRev - currentRev) / step) * Math.pow(m.score / 10, 2);
                if (efficiency > maxRiskAdjustedROI) { maxRiskAdjustedROI = efficiency; bestM = m; }
            });

            if (bestM && maxRiskAdjustedROI > 0) { allocations[bestM.market_id] += step; remaining -= step; } else break;
        }

        // 1. ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        document.querySelectorAll('tr').forEach(tr => tr.classList.remove('highlight-opt'));

        let html = '<table><thead><tr><th style="text-align:left;">Market</th><th>Score</th><th>Alloc</th><th>Yield/d</th></tr></thead><tbody>';
        const activeAllocations = Object.entries(allocations).filter(([_, a]) => a > 0).sort((a, b) => b[1] - a[1]);
        
        if (activeAllocations.length === 0) { resultDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--red);">N/A</div>'; return; }

        activeAllocations.forEach(([id, amt]) => {
            const m = marketData.find(md => md.market_id === id);
            const yieldVal = m.reward * (amt / (m.total_depth + amt));
            html += `<tr><td class="title-cell"><div class="title-container"><span class="title-text">${m.title}</span></div></td><td>${m.score.toFixed(1)}</td><td style="color:var(--gold); font-weight:bold;">$${amt}</td><td style="color:var(--accent); font-weight:bold;">$${yieldVal.toFixed(2)}</td></tr>`;
            
            // 2. [ì¶”ê°€] ë©”ì¸ í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ë§ˆì¼“ IDë¥¼ ê°€ì§„ tr ì°¾ì•„ì„œ í´ë˜ìŠ¤ ì¶”ê°€
            const targetRow = document.querySelector(`tr[data-market-id="${id}"]`);
            if (targetRow) targetRow.classList.add('highlight-opt');
        });
        resultDiv.innerHTML = html + '</tbody></table>';
    }

    async function updateWallet() {
        try {
            const res = await fetch(`${API_URL}/wallet`);
            const data = await res.json();
            document.getElementById('wallet-usdc').textContent = `$${Math.floor(data.usdc_balance).toLocaleString()}`;
        } catch (e) {}
    }

    async function updateMarkets() {
        try {
            const res = await fetch(`${API_URL}/honey-pots`);
            marketData = await res.json();
            const simAmt = parseFloat(document.getElementById('sim-amount').value) || 1000;
            
            // [ìˆ˜ì •] data-market-id ì†ì„±ì„ ì¶”ê°€í•˜ì—¬ ë‚˜ì¤‘ì— ì°¾ê¸° ì‰½ê²Œ í•¨
            document.getElementById('market-table-body').innerHTML = marketData.map(m => `
                <tr data-market-id="${m.market_id}" onclick="selectMarket('${m.market_id}')" style="cursor:pointer;">
                    <td style="color:var(--gold); font-weight:bold;">${m.score.toFixed(1)}</td>
                    <td class="title-cell"><div class="title-container"><span class="title-text" title="${m.title}">${m.title}</span><a href="https://polymarket.com/event/${m.slug}" target="_blank" class="link-icon" onclick="event.stopPropagation()">ğŸ”—</a></div></td>
                    <td style="color:var(--blue); font-weight:500;">${m.min_size}</td>
                    <td style="font-family:monospace">${m.mid_price ? m.mid_price.toFixed(3) : '0.500'}</td>
                    <td style="color:var(--text-muted)">$${Math.round(m.total_depth).toLocaleString()}</td>
                    <td>${m.spread_cents}Â¢</td>
                    <td class="profit-pos">$${(m.reward * (simAmt / (m.total_depth + simAmt))).toFixed(2)}</td>
                    <td>$${m.reward}</td>
                </tr>`).join('');
        } catch(e){}
    }

    // ë‚˜ë¨¸ì§€ ë³´ì¡° í•¨ìˆ˜ë“¤ (updateStatus, updateOrders, updateLogs, placeOrder ë“±)
    async function updateStatus() { try { const res = await fetch(`${API_URL}/status`); const d = await res.json(); const s = document.getElementById('bot-status'); s.textContent = d.is_halted ? "ğŸš¨ HALTED" : "ğŸŸ¢ ONLINE"; s.style.background = d.is_halted ? "var(--red)" : "var(--accent)"; } catch(e){} }
    async function updateOrders() { try { const res = await fetch(`${API_URL}/open-orders`); const grouped = await res.json(); const div = document.getElementById('open-orders'); if (Object.keys(grouped).length === 0) { div.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No orders</div>'; return; } div.innerHTML = Object.entries(grouped).map(([mid, outcomes]) => `<div class="order-group"><div style="font-size:10px; color:var(--blue); border-bottom:1px solid var(--border); padding-bottom:2px; word-break:break-all; text-align:left;">${mid}</div><div class="split"><div><b style="color:#7ee787; font-size:10px;">YES</b>${renderOrders(outcomes.YES)}</div><div><b style="color:#f85149; font-size:10px;">NO</b>${renderOrders(outcomes.NO)}</div></div></div>`).join(''); } catch(e){} }
    function renderOrders(orders) { if (!orders || orders.length === 0) return '<div style="font-size:10px; opacity:0.3; text-align:center;">-</div>'; return orders.map(o => `<div style="display:flex; justify-content:space-between; align-items:center; background:#0d1117; margin-top:2px; padding:2px; border-radius:3px; font-size:11px;"><span>${o.price}</span><button class="btn-cancel" onclick="cancelById('${o.order_id}')" style="background:var(--red); width:auto; height:18px; padding:0 4px; font-size:9px; color:white; border:none; border-radius:3px; cursor:pointer;">X</button></div>`).join(''); }
    async function updateLogs() { try { const res = await fetch(`${API_URL}/logs`); const logs = await res.json(); const logDiv = document.getElementById('logs'); logDiv.innerHTML = logs.map(l => `<div>${l}</div>`).join(''); logDiv.scrollTop = logDiv.scrollHeight; } catch(e){} }
    function selectMarket(id) { document.getElementById('order-market-id').value = id; }
    async function cancelById(id) { await fetch(`${API_URL}/cancel-order/${id}`, {method:'POST'}); updateOrders(); }
    async function batchCancelManual() { await fetch(`${API_URL}/batch-cancel-manual`, {method:'POST'}); updateOrders(); }
    async function placeOrder() { const id = document.getElementById('order-market-id').value; const amt = parseFloat(document.getElementById('order-amount').value); if(!id) return alert("Select market!"); const m = marketData.find(md => md.market_id === id); await fetch(`${API_URL}/place-semi-auto-order`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ market_id: id, amount: amt, yes_token_id: m.yes_token_id, no_token_id: m.no_token_id }) }); updateOrders(); }

    setInterval(updateStatus, 1500); 
    setInterval(updateWallet, 3000); 
    setInterval(updateMarkets, 5000);
    setInterval(updateOrders, 2000); 
    setInterval(updateLogs, 3000);
    updateMarkets(); updateStatus(); updateWallet(); updateOrders(); updateLogs();
</script>
</body>
</html>