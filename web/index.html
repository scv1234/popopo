<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Polymarket Pro - Interactive Optimizer</title>
    <style>
        :root { 
            --bg: #0d1117; --panel: #161b22; --border: #30363d; 
            --accent: #238636; --text: #c9d1d9; --text-muted: #8b949e;
            --red: #da3633; --gold: #e2b93d; --blue: #58a6ff;
            --gray: #484f58;
        }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding: 10px; font-size: 13px; height: 100vh; width: 100vw; box-sizing: border-box; overflow: hidden; 
        }
        .main-layout { display: grid; grid-template-columns: 280px 1fr 1.6fr; gap: 10px; height: calc(100vh - 20px); min-height: 0; }
        .column { display: flex; flex-direction: column; gap: 10px; height: 100%; min-height: 0; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; min-height: 0; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 6px; flex-shrink: 0; }
        
        h2 { margin: 0; font-size: 11px; color: var(--blue); text-transform: uppercase; letter-spacing: 0.5px; }
        .active-orders-title { 
            font-size: 14px !important; color: var(--gold) !important; letter-spacing: 1.5px !important; font-weight: 800;
            display: flex; align-items: center; gap: 8px;
        }
        .active-orders-title::before { content: ''; display: inline-block; width: 4px; height: 14px; background: var(--gold); border-radius: 2px; }

        /* Ïã§ÏãúÍ∞Ñ ÏÉÅÌÉúÎ∞î Ïä§ÌÉÄÏùº */
        .live-status-bar {
            display: flex; align-items: center; gap: 15px; padding: 8px 15px; 
            background: rgba(0,0,0,0.3); border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border);
        }
        .pulse-green { 
            width: 8px; height: 8px; background-color: #2ecc71; border-radius: 50%; 
            box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(46, 204, 113, 0); } 
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } 
        }

        .content-scroll { overflow-y: auto; flex-grow: 1; min-height: 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; } 
        th { text-align: center; color: var(--text-muted); padding: 8px 2px; font-size: 10px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--panel); z-index: 10; }
        td { padding: 8px 2px; border-bottom: 1px solid #21262d; font-size: 11px; vertical-align: middle; text-align: center; }
        
        .title-cell { text-align: left; overflow: hidden; }
        .title-container { display: flex; align-items: center; width: 100%; }
        .title-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; }

        @keyframes sparkle-glow {
            0% { background: rgba(35, 134, 54, 0.1); box-shadow: inset 0 0 5px var(--accent); }
            50% { background: rgba(226, 185, 61, 0.2); box-shadow: inset 0 0 15px var(--gold); }
            100% { background: rgba(35, 134, 54, 0.1); box-shadow: inset 0 0 5px var(--accent); }
        }
        .highlight-opt { animation: sparkle-glow 2s infinite ease-in-out; border: 1px solid var(--gold) !important; z-index: 5; }

        .stat-box { background: #0d1117; padding: 12px; border-radius: 4px; text-align: center; margin-bottom: 6px; }
        input, button { border-radius: 4px; padding: 8px; font-size: 12px; box-sizing: border-box; }
        input { background: #0d1117; border: 1px solid var(--border); color: white; width: 100%; margin-bottom: 8px; outline: none; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; width: 100%; font-weight: bold; }
        
        .logs { font-family: 'Consolas', monospace; font-size: 11px; color: var(--text-muted); white-space: pre-wrap; word-break: break-all; }
        .link-icon { text-decoration: none; color: var(--blue); font-size: 11px; margin-left: 4px; flex-shrink: 0; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            background: #161b22; color: white; padding: 12px 20px; border-radius: 6px; 
            border-left: 4px solid var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            font-size: 12px; min-width: 220px; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="live-status-bar">
    <div class="pulse-green" id="ws-indicator"></div>
    <span style="font-size: 11px; font-weight: bold; color: var(--text);">WS LIVE</span>
    <span id="last-update-time" style="font-size: 11px; color: var(--text-muted); margin-left: auto;">Last Update: --:--:--</span>
</div>

<div class="main-layout">
    <div class="column">
        <div class="panel" style="flex-shrink: 0;">
            <div class="panel-header"><h2>ü§ñ System</h2></div>
            <div class="stat-box">
                <small style="color: var(--text-muted); font-size: 10px; display: block;">USDC (RPC Wallet)</small>
                <div id="wallet-usdc" style="font-weight: bold; color: var(--gold); font-size: 22px;">$0</div>
            </div>
        </div>
        <div class="panel" style="flex-shrink: 0;">
            <div class="panel-header"><h2>üöÄ Quick Trade</h2></div>
            <input type="text" id="order-market-id" readonly placeholder="Click Market Opportunity" style="font-size: 11px; color: var(--blue);">
            <input type="number" id="order-amount" value="100">
            <button onclick="placeOrder()">Execute Order</button>
        </div>
        <div class="panel" style="flex-grow: 1;">
            <div class="panel-header"><h2>üìú Logs</h2></div>
            <div class="content-scroll"><div id="logs" class="logs"></div></div>
        </div>
    </div>

    <div class="column">
        <div class="panel" style="flex: 0.5;">
            <div class="panel-header"><h2>‚öñÔ∏è Optimizer</h2></div>
            <div style="display:flex; gap:6px; margin-bottom: 8px;">
                <input type="number" id="opt-budget" value="1000" style="margin:0;">
                <button onclick="runOptimizer()" style="width:70px;">Analyze</button>
            </div>
            <div id="optimizer-result" class="content-scroll">
                <div style="text-align:center; padding-top:20px; color:var(--text-muted);">Ready to analyze.</div>
            </div>
        </div>
        <div class="panel" style="flex: 0.5;">
            <div class="panel-header">
                <h2 class="active-orders-title">ACTIVE ORDERS</h2>
                <button onclick="batchCancelManual()" style="width:auto; padding: 2px 8px; font-size:10px; background:var(--red); border-radius:4px;">Cancel All</button>
            </div>
            <div id="open-orders" class="content-scroll"><div style="text-align:center; padding-top:20px; color:var(--text-muted);">No active orders</div></div>
        </div>
    </div>

    <div class="column">
        <div class="panel flex-grow-1">
            <div class="panel-header"><h2>üçØ Market Opportunities</h2><div style="display:flex; align-items:center; gap:5px;"><small style="font-size:10px; color:var(--text-muted);">Sim:</small><input type="number" id="sim-amount" value="1000" style="width:60px; margin:0; padding:4px; font-size:11px;" onchange="updateMarkets()"></div></div>
            <div class="content-scroll">
                <table id="main-market-table">
                    <thead><tr><th style="width:35px;">Scr</th><th style="width:auto;">Market Title</th><th style="width:40px;">Shr</th><th style="width:45px;">Mid</th><th style="width:60px;">Depth</th><th style="width:40px;">Sprd</th><th style="width:60px;">Est.R</th><th style="width:55px;">Rwd/d</th></tr></thead>
                    <tbody id="market-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8000";
    let marketData = [];
    let lastOptimizerAllocations = {};

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        if (type === 'error') toast.style.borderLeftColor = 'var(--red)';
        if (type === 'info') toast.style.borderLeftColor = 'var(--blue)';
        toast.innerHTML = `<strong>${type === 'error' ? '‚ùå Failed' : type === 'info' ? '‚ÑπÔ∏è Info' : '‚úÖ Success'}</strong><br>${message}`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 500); }, 3000);
    }

    function getMidPrice(m) {
        if (m.mid_yes !== undefined && m.mid_yes !== null) return m.mid_yes; 
        if (m.mid_price) return m.mid_price;
        return 0.500;
    }

    function selectMarket(marketId, slug) {
        const inputField = document.getElementById('order-market-id');
        inputField.dataset.realId = marketId;
        inputField.value = slug || marketId;
        inputField.style.backgroundColor = 'rgba(88, 166, 255, 0.2)';
        setTimeout(() => { inputField.style.backgroundColor = '#0d1117'; }, 300);
    }

    function runOptimizer() {
        const budget = parseFloat(document.getElementById('opt-budget').value) || 0;
        const resultDiv = document.getElementById('optimizer-result');
        if (marketData.length === 0) return;

        const step = 20; const maxAllocRatio = 0.35; const minROICutoff = 0.0005; const maxAllocPerMarket = budget * maxAllocRatio;
        lastOptimizerAllocations = {};
        marketData.forEach(m => lastOptimizerAllocations[m.market_id] = 0);
        let remaining = budget;

        while (remaining >= step) {
            let bestM = null; let maxEfficiency = -1;
            marketData.forEach(m => {
                const currentX = lastOptimizerAllocations[m.market_id];
                if (currentX + step > maxAllocPerMarket) return;
                const mPrice = getMidPrice(m);
                const minUSD = m.min_size * mPrice;
                const getRev = (amt) => (amt < minUSD) ? 0 : m.reward * (amt / (m.total_depth + amt));
                const efficiency = ((getRev(currentX + step) - getRev(currentX)) / step) * Math.pow(m.score / 10, 3.0);
                if (efficiency > maxEfficiency && efficiency > minROICutoff) { maxEfficiency = efficiency; bestM = m; }
            });
            if (bestM) { lastOptimizerAllocations[bestM.market_id] += step; remaining -= step; } else break;
        }

        document.querySelectorAll('tr').forEach(tr => tr.classList.remove('highlight-opt'));
        const activeAllocations = Object.entries(lastOptimizerAllocations).filter(([_, a]) => a > 0).sort((a, b) => b[1] - a[1]);
        if (activeAllocations.length === 0) { resultDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--red);">No Opportunity Found.</div>'; return; }

        let totalAllocated = 0, totalYield = 0, tableRows = '';
        activeAllocations.forEach(([id, amt]) => {
            const m = marketData.find(md => md.market_id === id);
            const yieldVal = m.reward * (amt / (m.total_depth + amt));
            totalAllocated += amt; totalYield += yieldVal;
            tableRows += `<tr style="cursor:pointer;" onclick="selectMarket('${id}', '${m.slug}')">
                <td class="title-cell"><div class="title-container"><span class="title-text">${m.title}</span></div></td>
                <td><span style="background:${getScoreColor(m.score)}; color:white; padding:2px 4px; border-radius:4px; font-weight:bold; font-size:10px;">${m.score.toFixed(1)}</span></td>
                <td style="color:var(--gold); font-weight:bold;">$${amt.toLocaleString()}</td>
                <td><div style="color:var(--accent); font-weight:bold;">+$${yieldVal.toFixed(2)}</div></td>
            </tr>`;
            const targetRow = document.querySelector(`tr[data-market-id="${id}"]`);
            if (targetRow) targetRow.classList.add('highlight-opt');
        });

        resultDiv.innerHTML = `
            <div style="margin-bottom:8px;"><button onclick="placeBatchOrders()">‚ö° OPTIMIZER AUTO ORDER</button></div>
            <table><thead><tr><th style="text-align:left;">Portfolio</th><th>Score</th><th>Alloc</th><th>Est.R</th></tr></thead><tbody>${tableRows}</tbody></table>
            <div style="margin-top:10px; padding:10px; background:rgba(255,215,0,0.05); border:1px solid rgba(255,215,0,0.1); border-radius:6px; display:flex; justify-content:space-around; text-align:center;">
                <div><div style="font-size:9px; color:var(--text-muted);">Total</div><div style="font-weight:bold; color:var(--gold);">$${totalAllocated.toLocaleString()}</div></div>
                <div><div style="font-size:9px; color:var(--text-muted);">Yield/d</div><div style="font-weight:bold; color:var(--accent);">+$${totalYield.toFixed(2)}</div></div>
            </div>`;
    }

    async function placeBatchOrders() {
        const targets = Object.entries(lastOptimizerAllocations).filter(([_, amt]) => amt > 0);
        if (targets.length === 0) return showToast("Analyze first!", "error");
        if (!confirm(`${targets.length}Í∞ú ÏãúÏû•Ïóê ÏùºÍ¥Ñ Ï£ºÎ¨∏ÏùÑ ÎÑ£ÏúºÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
        showToast(`Placing batch orders...`, 'info');
        for (const [id, amt] of targets) {
            const m = marketData.find(md => md.market_id === id);
            try {
                await new Promise(resolve => setTimeout(resolve, 300)); 
                await fetch(`${API_URL}/place-semi-auto-order`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ market_id: id, amount: amt, yes_token_id: m.yes_token_id, no_token_id: m.no_token_id }) 
                });
            } catch (e) { console.error(`Order failed for ${id}`, e); }
        }
        showToast("Optimizer batch orders completed!");
        updateOrders();
    }

    function getScoreColor(score) { return score >= 8.5 ? '#1a7f37' : score >= 7.0 ? '#9a6700' : '#cf222e'; }

    async function updateWallet() {
        try { const res = await fetch(`${API_URL}/wallet`); const data = await res.json(); document.getElementById('wallet-usdc').textContent = `$${Math.floor(data.usdc_balance).toLocaleString()}`; } catch (e) {}
    }

    async function updateMarkets() {
        try {
            const res = await fetch(`${API_URL}/honey-pots`);
            marketData = await res.json();
            const simAmt = parseFloat(document.getElementById('sim-amount').value) || 1000;
            document.getElementById('market-table-body').innerHTML = marketData.map(m => {
                const midP = getMidPrice(m);
                return `
                <tr data-market-id="${m.market_id}" onclick="selectMarket('${m.market_id}', '${m.slug}')" style="cursor:pointer;">
                    <td style="color:var(--gold); font-weight:bold;">${m.score.toFixed(1)}</td>
                    <td class="title-cell">
                        <div class="title-container">
                            <span class="title-text" title="${m.title}">${m.title}</span>
                            <a href="https://polymarket.com/event/${m.slug}" target="_blank" class="link-icon" onclick="event.stopPropagation()">üîó</a>
                        </div>
                    </td>
                    <td style="color:var(--blue); font-weight:500;">${m.min_size}</td>
                    <td style="font-family:monospace; color:${midP === 0.5 ? 'var(--text-muted)' : 'var(--blue)'}">${midP.toFixed(3)}</td>
                    <td style="color:var(--text-muted)">$${Math.round(m.total_depth).toLocaleString()}</td>
                    <td>${m.spread_cents}¬¢</td>
                    <td style="color:#7ee787; font-weight:bold;">$${(m.reward * (simAmt / (m.total_depth + simAmt))).toFixed(2)}</td>
                    <td>$${m.reward}</td>
                </tr>`;
            }).join('');
            document.getElementById('last-update-time').innerText = "Last Update: " + new Date().toLocaleTimeString();
            document.getElementById('ws-indicator').style.backgroundColor = '#2ecc71';
        } catch(e){ document.getElementById('ws-indicator').style.backgroundColor = '#da3633'; }
    }

    async function updateOrders() {
        try {
            const res = await fetch(`${API_URL}/open-orders`);
            const data = await res.json();
            const div = document.getElementById('open-orders');
            if (Object.keys(data).length === 0) { div.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">ÌôúÏÑ± Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</div>'; return; }

            div.innerHTML = Object.entries(data).map(([mid, outcomes]) => {
                const mInfo = marketData.find(m => m.market_id === mid);
                const displayName = mInfo ? mInfo.title : `Market: ${mid.substring(0, 8)}...`;
                return `
                <div style="border:1px solid var(--border); border-radius:6px; padding:10px; margin-bottom:12px; background:rgba(255,255,255,0.02);">
                    <div style="font-size:11px; color:var(--gold); font-weight:bold; margin-bottom:8px; border-bottom:1px solid var(--border); padding-bottom:5px;">
                        <span style="cursor:pointer;" onclick="selectMarket('${mid}', '${mInfo?.slug}')">üìç ${displayName}</span>
                    </div>
                    ${['YES', 'NO'].map(side => {
                        const orders = outcomes[side] || [];
                        if (orders.length === 0) return '';
                        return `
                        <div style="margin-bottom:6px;">
                            <div style="font-size:10px; color:var(--text-muted); margin-bottom:3px;">${side} Orders</div>
                            ${orders.map(o => `
                                <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:5px 8px; border-radius:4px; margin-top:3px; font-size:11px; border-left: 2px solid ${o.side === 'BUY' ? '#2ecc71' : '#e74c3c'};">
                                    <div style="display:flex; gap:12px;">
                                        <span style="color:${o.side === 'BUY' ? '#2ecc71' : '#e74c3c'}; font-weight:bold; width:30px;">${o.side}</span>
                                        <span style="font-family:monospace;">$${o.price.toFixed(3)}</span>
                                        <span style="color:var(--blue); font-weight:bold;">${o.size.toLocaleString()} Shares</span>
                                    </div>
                                    <button onclick="cancelById('${o.order_id}')" class="btn-cancel-mini">‚úï</button>
                                </div>`).join('')}
                        </div>`;
                    }).join('')}
                </div>`;
            }).join('');
        } catch (e) { console.error("Orders update failed:", e); }
    }

    async function updateLogs() { 
        try { 
            const res = await fetch(`${API_URL}/logs`); const logs = await res.json(); const logDiv = document.getElementById('logs'); 
            const orderKeywords = ['order', 'place', 'cancel', 'executed', 'trade', 'manual', 'defending'];
            const filteredLogs = logs.filter(log => { const lowerLog = log.toLowerCase(); return orderKeywords.some(key => lowerLog.includes(key)); });
            logDiv.innerHTML = filteredLogs.map(l => `<div>${l}</div>`).join(''); logDiv.scrollTop = logDiv.scrollHeight; 
        } catch(e){} 
    }

    async function cancelById(id) { await fetch(`${API_URL}/cancel-order/${id}`, {method:'POST'}); showToast(`Order cancelled`, 'info'); updateOrders(); }
    async function batchCancelManual() { if(confirm("Cancel all orders?")) { await fetch(`${API_URL}/batch-cancel-manual`, {method:'POST'}); showToast("All orders cancelled", 'error'); updateOrders(); } }
    
    async function placeOrder() { 
        const input = document.getElementById('order-market-id'); 
        const id = input.dataset.realId; 
        const amt = parseFloat(document.getElementById('order-amount').value); 
        if(!id) return showToast("Select a market first!", "error"); 
        const m = marketData.find(md => md.market_id === id); 
        if(!m) return showToast("Market data not found", "error");

        if(!confirm(`üöÄ Ï£ºÎ¨∏ÏùÑ Ïã§ÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nüìç ÏãúÏû•: ${m.title}\nüí∞ ÏàòÎüâ: ${amt} Shares`)) return;

        try {
            showToast("Placing manual order...", "info");
            const res = await fetch(`${API_URL}/place-semi-auto-order`, { 
                method: 'POST', headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ market_id: id, amount: amt, yes_token_id: m.yes_token_id, no_token_id: m.no_token_id }) 
            });
            if(res.ok) { showToast(`Ï£ºÎ¨∏ ÏÑ±Í≥µ!`, "success"); } else { showToast(`Ï£ºÎ¨∏ Ïã§Ìå®`, "error"); }
        } catch (e) { showToast("Connection error", "error"); }
        updateOrders(); 
    }

    // ÌÜµÌï© Í∞±Ïã† ÏóîÏßÑ (Ï£ºÍ∏∞ ÏµúÏ†ÅÌôî)
    setInterval(updateWallet, 5000); 
    setInterval(updateMarkets, 1500); 
    setInterval(updateOrders, 2000); 
    setInterval(updateLogs, 3000);

    // Ï¥àÍ∏∞ Î°úÎìú
    window.addEventListener('load', () => {
        updateMarkets(); updateWallet(); updateOrders(); updateLogs();
    });
</script>
</body>
</html>